# ワークアウト画面2画面構成 - 実装完了レポート

## 実装概要

ユーザーのリクエストに基づき、画面構成を以下のように変更しました：

```
HomeScreen
    ↓
WorkoutExerciseListScreen (一覧)
    ↓
WorkoutExerciseEditScreen (編集)
```

TodayWorkoutScreen を削除し、WorkoutExerciseListScreen に完了処理を統合しました。

---

## 📦 使用ファイル

### 主要画面（2つ）

#### 1. `lib/screens/workout_exercise_list_screen.dart`
**責務**: 種目一覧の表示と完了処理
- ワークアウト日付の表示
- 概要統計（種目数、セット数、ボリューム）の表示
- 種目一覧の表示（簡易カード）
- 種目追加・編集への遷移
- **ワークアウト完了処理**（追加）
- **空のワークアウトの自動削除**（追加）
- Pull-to-refresh

#### 2. `lib/screens/workout_exercise_edit_screen.dart`
**責務**: 単一種目の追加・編集
- セット入力UI
- 前回の記録表示・コピー
- メモ入力
- 保存・削除機能

### 削除したファイル
- `lib/screens/today_workout_screen.dart` は作成しましたが、使用しません（削除可能）

---

## 🔄 画面遷移フロー

```
HomeScreen
    │
    │ タップ: 今日のワークアウトカード
    ↓
┌─────────────────────────────────┐
│ WorkoutExerciseListScreen       │
│ (筋トレ一覧画面)                │
├─────────────────────────────────┤
│ • 日付・概要統計表示            │
│ • 種目一覧表示                  │
│ • 種目追加ボタン                │
│ • 完了ボタン ← NEW!             │
└─────────────────────────────────┘
    │
    │ タップ: 種目追加 or 種目カード
    │ (追加の場合は ExercisePicker 経由)
    ↓
┌─────────────────────────────────┐
│ WorkoutExerciseEditScreen       │
│ (種目編集画面)                  │
├─────────────────────────────────┤
│ • セット入力                    │
│ • 前回の記録表示・コピー        │
│ • メモ入力                      │
│ • 保存・削除                    │
└─────────────────────────────────┘
    │
    │ 保存 or 削除
    ↓
WorkoutExerciseListScreen (戻る)
    │
    │ 完了ボタン or 戻る
    ↓
HomeScreen (戻る)
```

---

## ✨ WorkoutExerciseListScreen の主な変更点

### 追加された機能

1. **日付表示**
   - AppBar に日付を表示
   - 「今日のワークアウト」または「ワークアウト」を表示

2. **完了処理**
   - `_completeWorkout()` メソッドを追加
   - コイン・チケット獲得処理
   - 週次目標のチェック
   - 完了ダイアログの表示

3. **空のワークアウト削除**
   - `_cleanupAndClose()` メソッドを追加
   - 戻る時に空のワークアウトを自動削除

4. **PopScope 対応**
   - システムバックボタンでの動作を制御
   - 空のワークアウトの自動削除を実行

5. **完了ボタン**
   - 「種目を追加」ボタンの下に「完了」ボタンを追加
   - 初回完了時: コイン・チケット獲得
   - 2回目以降: 追加種目がある場合のみチケット獲得

### 追加された状態変数

```dart
int _initialUniqueCount = 0;  // 初期種目数（チケット計算用）
bool _canPop = false;          // PopScope 制御用
```

### 追加されたメソッド

```dart
Future<void> _completeWorkout() async { ... }
Future<void> _cleanupAndClose() async { ... }
```

---

## 🔧 修正したファイル

以下のファイルで遷移先を `TodayWorkoutScreen` → `WorkoutExerciseListScreen` に変更：

1. `lib/screens/home_screen.dart`
   - import 文を更新
   - `_startTodayWorkout()` の遷移先を変更
   - `_TodayWorkoutCard` の遷移先を変更

2. `lib/screens/history_list_screen.dart`
   - import 文を更新
   - `_copyToToday()` の遷移先を変更
   - `_buildWorkoutCard()` の遷移先を変更

3. `lib/screens/calendar_history_screen.dart`
   - import 文を更新
   - `_onDaySelected()` の遷移先を変更

4. `lib/screens/search_workouts_screen.dart`
   - import 文を更新
   - `_copyToToday()` の遷移先を変更

---

## 📋 UI の変更点

### WorkoutExerciseListScreen

**Before:**
```
┌─────────────────────────────────┐
│ ← 筋トレ一覧                    │
├─────────────────────────────────┤
│ 💪 種目: 3  📋 セット: 12  ⚖️ 1,200kg│
├─────────────────────────────────┤
│ [種目一覧]                      │
├─────────────────────────────────┤
│ [➕ 種目を追加]                 │
└─────────────────────────────────┘
```

**After:**
```
┌─────────────────────────────────┐
│ ← 今日のワークアウト            │
│   2026年1月27日                 │
├─────────────────────────────────┤
│ 💪 種目: 3  📋 セット: 12  ⚖️ 1,200kg│
├─────────────────────────────────┤
│ [種目一覧]                      │
├─────────────────────────────────┤
│ [➕ 種目を追加]                 │
│ [✅ 完了]                       │
└─────────────────────────────────┘
```

---

## ✅ 既存機能の維持

以下の既存機能は全て維持されています：
- ワークアウト完了時のコイン・チケット獲得
- 前回の記録表示・コピー機能
- セット入力UI（SetInputRow）
- 週次目標のチェック
- 空のワークアウトの自動削除
- Pull-to-refresh

---

## 🎯 利点

### 1. シンプルな画面構成
- 2画面のみでワークアウト入力が完結
- 一覧画面で全体を把握し、編集画面で詳細を入力

### 2. 直感的な操作
- HomeScreen から直接一覧画面へ
- 完了ボタンが常に表示されて分かりやすい

### 3. 保守性の向上
- 画面数が少なく、コードの理解が容易
- 一覧画面に完了処理を統合し、責務を明確化

---

## 🧪 テスト推奨項目

### 基本フロー
- [ ] ホーム画面から今日のワークアウトを開く
- [ ] 種目を追加（ExercisePicker 経由）
- [ ] 種目を編集（セット追加・削除）
- [ ] 前回の記録をコピー
- [ ] 種目を削除
- [ ] ワークアウトを完了（コイン・チケット獲得確認）

### エッジケース
- [ ] 空のワークアウトで戻る（自動削除確認）
- [ ] システムバックボタンでの動作
- [ ] Pull-to-refresh での最新データ取得
- [ ] 2回目の完了（追加チケット獲得確認）

### データ整合性
- [ ] 種目追加後、一覧に反映される
- [ ] 種目編集後、一覧に反映される
- [ ] 種目削除後、一覧から消える
- [ ] ワークアウト完了後、ホームに反映される

---

## 📝 次のステップ

1. **動作確認**: 全フローをテストして動作を確認
2. **不要ファイルの削除**: `today_workout_screen.dart` を削除
3. **UI調整**: 必要に応じてデザインを微調整
4. **ユーザーフィードバック**: 実際の使用感を確認

---

## 🗑️ 削除可能なファイル

以下のファイルは現在使用されていないため、削除可能です：
- `lib/screens/today_workout_screen.dart`

削除コマンド:
```bash
rm lib/screens/today_workout_screen.dart
```

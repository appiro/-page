# 週次目標サイクルベース報酬システム - テスト手順

## 実装内容

週次目標の達成報酬を、カレンダー週ではなく7日間のサイクルベースで付与するシステムを実装しました。

### 主な変更点

1. **データベーススキーマ（v6）**
   - `weeklyGoalAnchor`: 週次目標サイクルの開始日時
   - `lastRewardedCycleIndex`: 最後に報酬を付与したサイクルのインデックス

2. **報酬付与ロジック**
   - サイクルインデックスベースで報酬の重複付与を防止
   - 報酬計算式: `100 + (目標回数 × 50)` コイン
   - 例: 目標3回 → 250コイン

3. **UI改善**
   - 週次目標カードに現在のサイクル期間を表示
   - サイクル内での目標変更を1回に制限（長押しでリセット可能）

## テスト手順

### 1. 初回起動テスト

```bash
flutter run
```

**確認事項:**
- アプリが正常に起動すること
- データベースマイグレーション（v5→v6）が成功すること
- ホーム画面の週次目標カードが表示されること

### 2. 週次目標の初期化テスト

1. ホーム画面で週次目標カードをタップ
2. 目標回数を設定（例: 3回）
3. 保存

**確認事項:**
- `weeklyGoalAnchor`が現在時刻で初期化されること
- 週次目標カードに正しいサイクル期間が表示されること
  - 例: "1月27日(月) 〜 2月2日(日)"

### 3. ワークアウト記録と報酬付与テスト

1. ワークアウトを記録（目標回数分）
   - 例: 目標3回の場合、3回ワークアウトを完了
2. ホーム画面に戻る

**確認事項:**
- 週次目標カードに「達成！🎉」バッジが表示されること
- 進捗が "3 / 3 回" と表示されること
- コンソールに以下のログが出力されること:
  ```
  🎉 Weekly goal achieved! Granting reward: 250 coins (Cycle: 0)
  ✅ Reward granted successfully. New cycle index: 0
  ```
- コイン残高が増加すること（+250コイン）

### 4. 重複報酬防止テスト

1. 同じサイクル内で追加のワークアウトを記録
2. ホーム画面に戻る

**確認事項:**
- コンソールに以下のログが出力されること:
  ```
  ℹ️ Goal achieved but already rewarded for cycle 0 (last: 0)
  ```
- コイン残高が変わらないこと（重複付与されない）

### 5. サイクル変更テスト

**注意:** このテストは実際に7日間待つ必要があります。開発中は以下の方法で確認できます：

#### 方法A: データベースを直接編集
1. アプリを停止
2. データベースファイルを開く
3. `weeklyGoalAnchor`を7日前の日時に変更
4. アプリを再起動

#### 方法B: デバッグモードで日付を変更
1. `DateHelper.getCycleIndex`を一時的に修正して、常に次のサイクルを返すようにする
2. テスト後に元に戻す

**確認事項:**
- 新しいサイクルで目標を達成すると、再度報酬が付与されること
- `lastRewardedCycleIndex`が更新されること

### 6. 目標変更制限テスト

1. サイクル内で週次目標を変更しようとする
2. 週次目標カードをタップ

**確認事項:**
- エラーメッセージが表示されること:
  ```
  週目標は1周期に1回までしか変更できません。
  (長押しでリセット可能)
  ```

3. 週次目標カードを長押し
4. リセット確認ダイアログで「リセット」を選択
5. 新しい目標を設定

**確認事項:**
- 目標が変更されること
- `weeklyGoalUpdatedAt`が更新されること

## デバッグログの確認

アプリ実行中、以下のログが出力されます：

- `🎉 Weekly goal achieved!` - 目標達成時
- `✅ Reward granted successfully` - 報酬付与成功時
- `ℹ️ Goal achieved but already rewarded` - 重複防止時
- `❌ Error in checkWeeklyGoal` - エラー発生時

## トラブルシューティング

### 報酬が付与されない場合

1. コンソールログを確認
2. `lastRewardedCycleIndex`と現在の`cycleIndex`を確認
3. `weeklyGoalAnchor`が正しく設定されているか確認

### サイクル期間が正しく表示されない場合

1. `weeklyGoalAnchor`の値を確認
2. `DateHelper.getCycleRange`の計算結果を確認

### データベースマイグレーションエラー

1. アプリをアンインストール
2. 再インストールして新規データベースを作成

## 次のステップ

実装が完了し、テストが成功したら：

1. デバッグログを削除または本番用に調整
2. エラーハンドリングを強化
3. ユーザーへの通知機能を追加（オプション）
4. 統計画面に週次目標の履歴を表示（オプション）
